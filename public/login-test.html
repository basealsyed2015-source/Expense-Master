<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .step-active {
            background: #10b981;
            color: white;
        }
        .step-pending {
            background: #f3f4f6;
            color: #6b7280;
        }
        .step-error {
            background: #ef4444;
            color: white;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-4">
            <h1 class="text-3xl font-bold text-center mb-6">
                <i class="fas fa-vial ml-2"></i>
                Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„
            </h1>

            <!-- Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
            <div class="space-y-3 mb-6">
                <div id="step1" class="step-pending p-4 rounded-lg flex items-center justify-between">
                    <span><strong>1ï¸âƒ£ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</strong></span>
                    <i class="fas fa-spinner fa-spin" id="icon1"></i>
                </div>
                <div id="step2" class="step-pending p-4 rounded-lg flex items-center justify-between">
                    <span><strong>2ï¸âƒ£ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†</strong></span>
                    <i class="fas fa-clock" id="icon2"></i>
                </div>
                <div id="step3" class="step-pending p-4 rounded-lg flex items-center justify-between">
                    <span><strong>3ï¸âƒ£ Ø­ÙØ¸ ÙÙŠ Cookies + LocalStorage</strong></span>
                    <i class="fas fa-clock" id="icon3"></i>
                </div>
                <div id="step4" class="step-pending p-4 rounded-lg flex items-center justify-between">
                    <span><strong>4ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸</strong></span>
                    <i class="fas fa-clock" id="icon4"></i>
                </div>
                <div id="step5" class="step-pending p-4 rounded-lg flex items-center justify-between">
                    <span><strong>5ï¸âƒ£ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ /admin/panel</strong></span>
                    <i class="fas fa-clock" id="icon5"></i>
                </div>
            </div>

            <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
            <div class="bg-gray-100 p-6 rounded-lg mb-4">
                <h3 class="font-bold text-lg mb-4">Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                        <input type="text" id="username" value="admin_tamweel1" 
                               class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±:</label>
                        <input type="password" id="password" value="demo123" 
                               class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <button onclick="startTest()" id="startBtn"
                        class="w-full bg-gradient-to-r from-green-600 to-blue-600 text-white py-3 rounded-lg font-bold hover:from-green-700 hover:to-blue-700">
                    <i class="fas fa-play ml-2"></i>
                    Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†
                </button>
            </div>

            <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
            <div id="results" class="hidden">
                <h3 class="font-bold text-lg mb-4">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</h3>
                <div class="space-y-3">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <strong>Ø§Ø³ØªØ¬Ø§Ø¨Ø© API:</strong>
                        <pre id="apiResponse" class="mt-2 bg-white p-3 rounded text-xs overflow-x-auto"></pre>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <strong>Cookies Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</strong>
                        <pre id="cookiesResult" class="mt-2 bg-white p-3 rounded text-xs overflow-x-auto"></pre>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <strong>LocalStorage:</strong>
                        <pre id="localStorageResult" class="mt-2 bg-white p-3 rounded text-xs overflow-x-auto"></pre>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <strong>Ø§Ø®ØªØ¨Ø§Ø± /admin/panel:</strong>
                        <pre id="panelTest" class="mt-2 bg-white p-3 rounded text-xs overflow-x-auto"></pre>
                    </div>
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ -->
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <a href="/admin/panel" class="block text-center bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold">
                        <i class="fas fa-chart-line ml-2"></i>
                        Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    </a>
                    <a href="/test-auth" class="block text-center bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-bold">
                        <i class="fas fa-bug ml-2"></i>
                        ØµÙØ­Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        function updateStep(stepNum, status, icon) {
            const step = document.getElementById(`step${stepNum}`);
            const iconEl = document.getElementById(`icon${stepNum}`);
            
            step.className = `step-${status} p-4 rounded-lg flex items-center justify-between`;
            iconEl.className = `fas fa-${icon}`;
        }

        async function startTest() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const startBtn = document.getElementById('startBtn');
            const results = document.getElementById('results');
            
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...';
            results.classList.add('hidden');
            
            try {
                // Step 1: Login API
                updateStep(1, 'active', 'spinner fa-spin');
                const response = await axios.post('/api/auth/login', {
                    username,
                    password,
                    rememberMe: true
                }, {
                    withCredentials: true
                });
                
                updateStep(1, 'active', 'check');
                document.getElementById('apiResponse').textContent = JSON.stringify(response.data, null, 2);
                
                // Step 2: Check token
                updateStep(2, 'active', 'spinner fa-spin');
                await new Promise(r => setTimeout(r, 500));
                if (response.data.token) {
                    updateStep(2, 'active', 'check');
                } else {
                    updateStep(2, 'error', 'times');
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ†');
                }
                
                // Step 3: Save token
                updateStep(3, 'active', 'spinner fa-spin');
                const token = response.data.token;
                
                // Save in LocalStorage
                localStorage.setItem('authToken', token);
                localStorage.setItem('userData', JSON.stringify(response.data.user));
                
                // Save in Cookie
                const maxAge = 7 * 24 * 60 * 60;
                document.cookie = `authToken=${token}; path=/; max-age=${maxAge}; SameSite=Lax`;
                
                await new Promise(r => setTimeout(r, 500));
                updateStep(3, 'active', 'check');
                
                // Step 4: Verify saved data
                updateStep(4, 'active', 'spinner fa-spin');
                const savedCookies = document.cookie;
                const savedLocalStorage = {
                    authToken: localStorage.getItem('authToken'),
                    userData: localStorage.getItem('userData')
                };
                
                document.getElementById('cookiesResult').textContent = savedCookies || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆÙƒÙŠØ²';
                document.getElementById('localStorageResult').textContent = JSON.stringify(savedLocalStorage, null, 2);
                
                if (savedCookies.includes('authToken') && savedLocalStorage.authToken) {
                    updateStep(4, 'active', 'check');
                } else {
                    updateStep(4, 'error', 'times');
                    throw new Error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
                
                // Step 5: Test /admin/panel
                updateStep(5, 'active', 'spinner fa-spin');
                await new Promise(r => setTimeout(r, 1000));
                
                try {
                    const panelResponse = await axios.get('/admin/panel', {
                        withCredentials: true
                    });
                    
                    // Check if we got the panel or login page
                    if (panelResponse.data.includes('ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨')) {
                        updateStep(5, 'error', 'times');
                        document.getElementById('panelTest').textContent = 'âŒ Ø§Ù„ØµÙØ­Ø© ØªØ·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!\n\nØ§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ù„Ø§ ØªÙØ±Ø³Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ getUserInfo Ù„Ø§ ÙŠÙ‚Ø±Ø£Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.';
                    } else if (panelResponse.data.includes('Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…') || panelResponse.data.includes('admin-panel')) {
                        updateStep(5, 'active', 'check');
                        document.getElementById('panelTest').textContent = 'âœ… Ù†Ø¬Ø­! ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…';
                    } else {
                        updateStep(5, 'pending', 'question');
                        document.getElementById('panelTest').textContent = 'ØºÙŠØ± ÙˆØ§Ø¶Ø­ - Ø§ÙØ­Øµ Ø§Ù„ØµÙØ­Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹';
                    }
                } catch (panelError) {
                    updateStep(5, 'error', 'times');
                    document.getElementById('panelTest').textContent = `Ø®Ø·Ø£: ${panelError.message}`;
                }
                
                results.classList.remove('hidden');
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-redo ml-2"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±';
                
            } catch (error) {
                console.error('Test error:', error);
                alert(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`);
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play ml-2"></i> Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†';
            }
        }

        // Auto-start on load (optional)
        // window.addEventListener('load', () => setTimeout(startTest, 1000));
    </script>
</body>
</html>
